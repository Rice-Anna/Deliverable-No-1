---
title: "Portfolio Deliverable 1"
author: "Anna Rice"
date: "10/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Introduction
The data I have decided to work with and analyze this semester is California Prune Grower data from 2018 and 2019. I currently intern with a company that processes prunes and works alongside a co-op of growers to turn their prunes into a variety of different products sold all across the world. This data does not include all prune growers in California, but the majority of them as the co-op yields enough crop which makes up approximately 75% of the US prune market. The data set includes the reports of the sampling process which determines the pay of each load of prunes. Every observation is based upon a 40,000 to 60,000 lb collection of prunes that have already been dried and are ready for inventory. Roughly 40 lbs of each load is sampled for defect analysis. This analysis is then used to determine the amount paid to a grower for that load of prunes. 

## Source
The data collected is generated from the reports of the DFA of California, whom inspects a sample of a grower's crop for defects and food quality control. The data is reliable as it comes from this entity, however out of the 40 lbs of the sample that is sent to the DFA to analyze, which is roughly 3,000 prunes, only 400-700 prunes are actually analyzed in the sampling process. In essence it is a sample of a sample and thus the limiting factor to this process is that payments and defect rates are calculated off of a small portion of a sample. 

## Variables
There are over 60 variables in these reports generated by the DFA, but the main focus in this analysis are those variables used to calculate grower defect rates and analyze the sizes of prunes that are defective. These variables are subject to change and be added onto in further analysis, but for the beginning stages of this project, there are:  
CropYear - the year the report is referring to for the crop yield of a grower  
SampleNo - the number given to each 40,000-60,000 lbs load of prunes that generates each observation  
GrowerID - The ID number given to each grower to identify the source of the crop  
LotID - The ID number assigned to each lot. A lot is just a way to break down a grower's orchards if they have land in multiple counties or areas. This is just used for payment separation if a grower decides to split their payment between their orchards  
Region - There are 3 regions that California is broken up into   
DryerName - The name of the dryer where crop was delivered to be turned from a plum to a prune. The name of the dryer is also the location   
SampledWeight - This is the weight of the load that a sample is being taken from. This falls within the 40,000-60,000 lbs referred to earlier  
TotalTestBase - This is the number of prunes that is being analyzed by the DFA of California to determine defects among a grower's crop. This is the 400-700 prunes that get sampled from the 40 lb sample taken from each observation  
TotalScreenWeight - This is the total weight of the sample taken from the SampledWeight. This number is around 40 lbs  
TOTAL_DefectsTotal - This is the amount of prunes that the DFA finds defective from the TotalTestBase that they analyze  
DefectRate - This is the rate of how many defects are in the Test Base that DFA of California analyzes. This rate is applied to the whole load of prunes for the observation to determine the defect rate that growers will be payed by  
DefectWeight - This is the weight of the crop that is defective in a grower's crop. This is calculated from applying the defect rate to the SampledWeight

## Tidy Data
This data was already tidy to begin with as it was entered in a report to keep track of the data. I did eliminate most of the unneeded variables and add the calculated variables of DefectRate and DefectWeight. I also have tried to group the data by GrowerID and LotID, however I am still learning to analze grouped data. 
```{r}
d <- read_csv("C:\\Users\\Anna's Dell Laptop\\CSCI 385\\Data Sets\\2018_2019 Growers Data.csv")

d %>%
  mutate( DefectRate = TOTAL_DefectsTotal / TOTAL_TestBase, DefectWeight = DefectRate * SampledWeight ) %>%
  select(CropYear, RegionName, DryerName, GrowerID, LotID, SampledWeight, TOTAL_ScreenWeight, TOTAL_TestBase, TOTAL_DefectsTotal, DefectRate, DefectWeight) %>%
  group_by( GrowerID, LotID)
``` 

## Descriptive Stats
The following are a few averages for the key continuos variables as well as the most frequently occuring Grower, Region, and Lot.
```{r}
mean(d[["SampledWeight"]])
mean(d[["TOTAL_ScreenWeight"]])
mean(d[["TOTAL_TestBase"]])

Modes <- function(x) {
  ux <- unique(x)
  tab <- tabulate(match(x, ux))
  ux[tab == max(tab)]
}

Modes(d[["GrowerID"]])
Modes(d[["LotID"]])
Modes(d[["RegionName"]])
```

Here the distribution of growers is visualized and how much they contribute to the overall market of production. The growers with more loads, or observations, have more crop being produced and sold. Here we can break growers into categories of Small, Medium, Large, and Extra-Large with the amount of loads they can produce. It seems like the growers with more loads, have crop in multiple regions.

```{r}
d %>%
  mutate( DefectRate = TOTAL_DefectsTotal / TOTAL_TestBase, DefectWeight = DefectRate * SampledWeight ) %>%
  select(CropYear, RegionName, DryerName, GrowerID, LotID, SampledWeight, TOTAL_ScreenWeight, TOTAL_TestBase, TOTAL_DefectsTotal, DefectRate, DefectWeight) %>%
  ggplot()+
  geom_histogram(mapping = aes(x = GrowerID, color = RegionName), binwidth = 1)+
  facet_wrap(~CropYear)
```

Next we can look at the defect rate per load a grower delivers and break them into the regions to see if the location has any significant effects on defect rates and this would indicate a need for further analysis in regional data like weather. It appears that Region 3 has an overall trend of lower defect rates for the growers with crop in that region in comparison to the other two regions.  
```{r}
d %>%
  mutate( DefectRate = TOTAL_DefectsTotal / TOTAL_TestBase, DefectWeight = DefectRate * SampledWeight ) %>%
  select(CropYear, RegionName, DryerName, GrowerID, LotID, SampledWeight, TOTAL_ScreenWeight, TOTAL_TestBase, TOTAL_DefectsTotal, DefectRate, DefectWeight) %>%
  ggplot()+
  geom_point(mapping = aes(x = GrowerID, y = DefectRate))+
  facet_wrap(~RegionName)
```
We can also look to see if any specific dryer had higher defect rates and if so, potentially a process that that specific dryer uses is causing defects for growers. It seems that Hamilton City Dryer, Gridley Dryer, and Lindauer River Ranch Dryer may have some higher defect rates with the crop being sent to them. This is a correlation, not necessarily causation due to a procedural or mechanical error on their part. 
```{r}
d %>%
  mutate( DefectRate = TOTAL_DefectsTotal / TOTAL_TestBase, DefectWeight = DefectRate * SampledWeight ) %>%
  select(CropYear, RegionName, DryerName, GrowerID, LotID, SampledWeight, TOTAL_ScreenWeight, TOTAL_TestBase, TOTAL_DefectsTotal, DefectRate, DefectWeight) %>%
  ggplot()+
  geom_point(mapping = aes(x = GrowerID, y = DefectRate))+
  facet_wrap(~DryerName)
```

We then can verify that each sample is roughly 40 lbs that is taken from each of the 40,000-60,000 lbs loads or observations. Majority of the weights of the samples taken to be analyzed by DFA are clustered around the 40 lb mark, with some exceptions.
```{r}
d %>%
  mutate( DefectRate = TOTAL_DefectsTotal / TOTAL_TestBase, DefectWeight = DefectRate * SampledWeight ) %>%
  select(CropYear, RegionName, DryerName, GrowerID, LotID, SampledWeight, TOTAL_ScreenWeight, TOTAL_TestBase, TOTAL_DefectsTotal, DefectRate, DefectWeight) %>%
  ggplot()+
  geom_point(mapping = aes(x = TOTAL_ScreenWeight, y = SampledWeight, color = RegionName))
```
  The number of prunes that DFA takes from the sample pulled from each load seems to correlate to the weight of the sample taken. This makes sense, as the more prunes there are in a sample, the more DFA pulls to analyze. The noticeable trend of the amount of prunes being analyzed at an even interval of 100s also appears to show a trend in pulling even 100 amounts of prunes from the various sizes of prunes. 
```{r}
d %>%
  mutate( DefectRate = TOTAL_DefectsTotal / TOTAL_TestBase, DefectWeight = DefectRate * SampledWeight ) %>%
  select(CropYear, RegionName, DryerName, GrowerID, LotID, SampledWeight, TOTAL_ScreenWeight, TOTAL_TestBase, TOTAL_DefectsTotal, DefectRate, DefectWeight) %>%
  ggplot()+
  geom_point(mapping = aes(x = TOTAL_TestBase, y = TOTAL_ScreenWeight, color = RegionName))+
  facet_wrap(~CropYear)
```


## Data Science Questions
1. Can the total defect rate of a grower be predicted before harvest?  
This is the current question at hand with the given variables and data set. Additional data such as weather for the specified regions and acreage from another type of report within the company may need to be merged and added to this data set.   
2. Can a grower's defect types be predicted before harvest?  
This question requires some of the other 60 variables within the data, and only needs some rearranging of the data to see the correlations and stats associated with it.  
3. Can the sampling process for analyzing defective crop be more precise given the implementation of technology and analysis on past data?  
This also requires some of the other variables within the generated reports from the DFA of California to explore. Depending on where the current data leads with question 1, will determine if this is further explored within this specific project.   
  
    
Being able to predict a grower's defect rate before they harvest can have some significant impacts on the grower. A grower is paid on the crop that they yield that is not defective. Defective crop is counted against the grower and charged to the grower as the processing company can only use this kind of crop to turn into one less profitable product, juice. Knowing the defect rate ahead of time, a grower can arrange their resources to minimize their losses on their crop through the resources they are putting out to yield this defective portion of crop. In turn, when a grower maximizes profits, a co-op run processing company also maximizes profits by being able to diversify their products into more profitable products from the crop that they buy from growers.  
The sampling data science questions will increase profits for growers and the processing company as well, as a more accurate and precise payment is made per load that a grower produces and sells to the company based upon these sample projections. 